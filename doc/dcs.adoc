= 版本控制系统

:toc:

== 1.文档历史

|===
|版本号|日期|修改原因|修改人
|1.0|2023.05.30|创建|吴方
|===

== 2.文档介绍

=== 2.1.文档的目的

本文档编写的主要目的：

. 定制项目管理的解决方案
. 为功能开发提供详细解决方案

=== 2.2.文档的读者

本文档的阅读者是软件开发人员，系统管理员，项目经理，项目使用人员，运维人员等。

=== 2.3.参考文档
《版本控制需求》

== 3.总体方案说明

=== 3.1 建设目标

基于甲方业务需求，实现基于智能终端的边缘计算平台的重点技术预研和功能组件花工作。开发符合甲方要求的相应软件。完成甲方的开发目标。

=== 3.2 系统说明

    版本管理系统是服务于边缘计算系统的一个组件，负责从应用仓库下载已订阅的边缘APP，并可自动升级或回滚至指定版本，共数万的风场边缘计算设备轻松的管理边缘APP的运行版本

=== 3.3 系统架构

image::{image}./bus.png[, 800]


=== 3.4 架构说明

==== 3.4.1 数据服务平台
    数据服务平台提供数据采集，数据存储和实时数据发布能基础数据功能。

===== 3.4.1.1.数据引擎
    用来对接所有的数据系统的中间件软件。
    
===== 3.4.1.2.数据缓存
    用于缓存热点数据，例如系统阈值，通知列表等常用热点数据
    
===== 3.4.1.3.数据库
    用户数据存储持久化的中间件，推荐使用MySql
    
===== 3.4.1.4.文件系统
    用户存储应用文件的的系统组件，负责文件存储位置的计算，目录管理，文件去重等功能。
    
==== 3.4.2.公共服务平台
    公共服务平台提供对接远程仓库，对接终端设备，版本策略计算与执行等公共服务。
    
===== 3.4.2.1.仓库管理
    负责和远程仓库的连接，接收远程仓库的数据推送，订阅远程仓库的更新，下载远程仓库的
    
===== 3.4.2.2.指令管理
    负责管理与所有终端系统连接的指令系统。通过指令系统向终端发送更新/回滚等指令来完成应用的操作
    
===== 3.4.2.3.本地仓库
    负责管理从云端仓库下载下来的应用，作为应用的本地缓存。
    
===== 3.4.2.4.连接管理
    负责管理终端的在线连接，并通过连接通道与终端通讯。
    
===== 3.4.2.4.行为管理
    负责记录用户在版本管理系统中的操作记录。
    
==== 3.4.3 业务服务平台
    负责提供订阅，用户信息，设备信息，更新策略等所有业务需求的业务逻辑。
    
===== 3.4.3.1.订阅管理
    负责管理用户的app的订阅信息及相关逻辑。
    
===== 3.4.3.2.用户管理
    负责即同一设计场端用户的信息管理。
    
===== 3.4.3.3.设备管理
    负责查看，管理在线的终端设备。
    
===== 3.4.3.4.策略管理
    提供用户设定，修改，删除版本策略的所有功能。
    
=== 3.5 设计原则

==== 3.5.1.采用先进和成熟的技术
    各系统均采用多层体系结构，使用JSON规范作为信息交互的标准，并且采用先进、成熟的软硬件平台及相关标准作为系统的基础。

==== 3.5.2.快速开发/快速修改原则

    系统提供灵活的开发手段，在面向对象的业务组件应用框架上，能够在不影响系统情况下快速开发新业务，同时提供方便地对业务进行修改和动态加载的支持。

==== 3.5.3.具有良好的可扩展性

    要能够支持多个层面的可扩展性，通过负载平衡、快速开发/重组、业务参数配置等多个方面使得系统可以支持未来仓储WMS未来不断变化的业务特征。

==== 3.5.4.安全性和可靠性

    系统针对数据库、网络、应用等各层次制定相应的安全策略和可靠性策略保障系统的安全性和可靠性。

== 4.数据字典
=== 4.1.基础策略定义表
base_policy
|===
|字段|类型|可空|说明
|id|bigint|NO|
|create_time|timestamp|NO|
|update_time|timestamp|YES|
|condition|int|YES|执行条件，1-有更新，2-执行失败，3-资源超标
|version_target|varchar(45)|YES|目标版本，1-稳定版，2-上次运行稳定版，3-最新版，4-最近的稳定版
|action|int|YES|执行动作，1-更新，2-回滚
|delay|bigint|YES|执行周期，秒
|===
=== 4.2.设备信息表
device
|===
|字段|类型|可空|说明
|id|bigint|NO|
|create_time|timestamp|NO|
|update_time|timestamp|YES|
|unique|varchar(45)|YES|设备唯一编码
|last_time|timestamp|YES|最后连接时间
|device_name|varchar(45)|YES|设备名称
|===
=== 4.3.策略模版表
device_plan
|===
|字段|类型|可空|说明
|id|bigint|NO|
|create_time|timestamp|NO|
|update_time|timestamp|YES|
|source_plan_id|bigint|YES|来源模版id
|device_id|bigint|YES|
|===
=== 4.4.策略详情表
plan_policy_detail
|===
|字段|类型|可空|说明
|id|bigint|NO|
|create_time|timestamp|NO|
|update_time|timestamp|YES|
|condition|int|YES|执行条件，1-有更新，2-执行失败，3-资源超标
|version_target|varchar(45)|YES|目标版本，1-稳定版，2-上次运行稳定版，3-最新版，4-最近的稳定版
|action|int|YES|执行动作，1-更新，2-回滚
|delay|bigint|YES|执行周期，秒
|device_plan_id|bigint|YES|策略表id
|===
=== 4.5.策略模版表
plan_template
|===
|字段|类型|可空|说明
|id|bigint|NO|
|create_time|timestamp|NO|
|update_time|timestamp|YES|
|name|varchar(45)|YES|模版名称
|===
=== 4.6.模版策略表
template_policy
|===
|字段|类型|可空|说明
|id|bigint|NO|
|create_time|timestamp|NO|
|update_time|timestamp|YES|
|condition|int|YES|执行条件，1-有更新，2-执行失败，3-资源超标
|version_target|varchar(45)|YES|目标版本，1-稳定版，2-上次运行稳定版，3-最新版，4-最近的稳定版
|action|int|YES|执行动作，1-更新，2-回滚
|delay|bigint|YES|执行周期，秒
|template_id|bigint|YES|模版表id
|===
=== 4.7.用户表
user
|===
|字段|类型|可空|说明
|id|bigint unsigned|NO|
|username|varchar(16)|NO|用户名称
|email|varchar(255)|YES|邮箱地址
|password|varchar(32)|NO|密码
|create_time|timestamp|YES|
|===


== 4.接口设计
=== 4.1 内部接口
==== 4.1.1 创建策略模板

|===
|地址 | /template | 方法| PUT
|功能描述 3+|创建策略模板
|输入参数 3+|模板名称，模板策略列表
|执行过程 3+|判断模板名称是否重复，策略数据校验，模板数据与策略数据入库，生成操作记录
|输出结果 3+|创建成功或者失败
|===

==== 4.1.2 编辑策略模板

|===
|地址 | /template/{id} | 方法| POST
|功能描述 3+|编辑策略模板
|输入参数 3+|模板id，模板名称，模板策略列表
|执行过程 3+|判断模板名称是否重复，策略数据校验，模板数据与策略数据更新，生成操作记录
|输出结果 3+|更新成功或者失败
|===


==== 4.1.3 设备关联更新策略
|===
|地址| /device/plan | 方法 | PUT
|功能描述 3+|将策略模板关联至指定设备
|输入参数 3+|设备id，模板id，模板策略列表
|执行过程 3+|验证设备id，验证模板id，根据模板生成对应策略，写入数据库，生成操作记录
|输出结果 3+|创建成功或者失败
|===

==== 4.1.4 修改设备更新策略
|===
|地址| /device/plan | 方法 | POST
|功能描述 3+|修改设别更新策略
|输入参数 3+|设备id，策略列表
|执行过程 3+|验证设备id，验证策略数据，写入数据库，生成操作记录
|输出结果 3+|修改成功或者失败
|===

==== 4.1.5 根据设备策略生成模板
|===
|地址| /device/transfer | 方法 | POST
|功能描述 3+|将设备策略转换为模板
|输入参数 3+|设备id，模板名称，策略列表
|执行过程 3+|验证设备id，验证策略数据，写入数据库，生成操作记录
|输出结果 3+|修改成功或者失败
|===

==== 4.1.6 查看设备列表

|===
|地址 | /template | 方法| GET
|功能描述 3+|查看设备列表
|输入参数 3+|分页参数，页号，每页行数
|执行过程 3+|查询设备数据并返回
|输出结果 3+|设备信息分页数据
|===
=== 4.2 外部接口

==== 4.2.1 设备注册
|===
|地址| /device/register | 方法 | GET
|功能描述 3+|修改设别更新策略
|输入参数 3+|设备id
|执行过程 3+|验证设备id，生成设备数据，更新设备在线状态
|输出结果 3+|成功或失败
|===

=== 4.2.2 设备心跳
|===
|地址| /device/heardbeat | 方法 | GET
|功能描述 3+|设备心跳
|输入参数 3+|设备id
|执行过程 3+|验证设备id，更新设备在线状态
|输出结果 3+|成功或失败
|===

== 5.系统的非功能设计

=== 5.1 性能设计（场端）

|===
|主要质量指标|详细要求
|并发数|系统同时访问至少支持10个客户端同时访问
|连接数|系统至少支持10000个终端同时连接
|平均事件响应时间|小于1s
|负载率|服务器与性过程中，CPU负载小于70%
|内存使用率|服务器运行过程中，内存消耗小于70%
|===















